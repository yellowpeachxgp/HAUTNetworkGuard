name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows-qt:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtnetworkauth'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: cmake -B build -S Windows -DCMAKE_BUILD_TYPE=Release
        
      - name: Build
        run: cmake --build build --config Release

      - name: Deploy Qt Runtime
        run: |
          mkdir HAUTNetworkGuard-Windows
          copy build\Release\HAUTNetworkGuard.exe HAUTNetworkGuard-Windows\
          windeployqt HAUTNetworkGuard-Windows\HAUTNetworkGuard.exe --release --no-translations --no-opengl-sw

      - name: Create Installer ZIP
        run: Compress-Archive -Path HAUTNetworkGuard-Windows -DestinationPath HAUTNetworkGuard-Windows.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: HAUTNetworkGuard-Windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS App
        run: |
          cd macOS
          chmod +x build.sh create-dmg.sh
          ./build.sh
          ./create-dmg.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: macOS/build/HAUTNetworkGuard.dmg

  release:
    needs: [build-windows-qt, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## HAUTNetworkGuard ${{ steps.get_version.outputs.VERSION }}
            
            æ²³å—å·¥ä¸šå¤§å­¦æ ¡å›­ç½‘è‡ªåŠ¨ç™»å½•å·¥å…·
            
            ### ğŸ“¦ ä¸‹è½½
            
            | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **Windows** | `HAUTNetworkGuard-Windows.zip` | è§£å‹åè¿è¡Œ `HAUTNetworkGuard.exe` |
            | **macOS** | `HAUTNetworkGuard.dmg` | åŒå‡»å®‰è£…åˆ°åº”ç”¨ç¨‹åº |
            | **OpenWrt** | ä¸€é”®å®‰è£… | `wget -qO- https://raw.githubusercontent.com/yellowpeachxgp/HAUTNetworkGuard/main/OpenWrt/install-online.sh \| sh` |
            
            ### ğŸ”„ æ›´æ–°å†…å®¹
            
            è¯¦è§ [README.md ç‰ˆæœ¬å†å²](https://github.com/yellowpeachxgp/HAUTNetworkGuard#ç‰ˆæœ¬å†å²)
            
            ---
            
            **é¦–æ¬¡ä½¿ç”¨**: è¿è¡Œåè¾“å…¥å­¦å·å’Œå¯†ç ï¼Œå‹¾é€‰"è®°ä½å¯†ç "å’Œ"å¼€æœºè‡ªå¯åŠ¨"å³å¯ã€‚
          files: |
            HAUTNetworkGuard-Windows.zip
            HAUTNetworkGuard.dmg
